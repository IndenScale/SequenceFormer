# 工作笔记 2025-08-12: 战略重构与多模态整合

今天的工作是本项目从一个强大的原型，向一个真正健壮、可靠的工业级组件演进的关键一天。我们经历了深刻的战略反思，并成功地集成了一个全新的、复杂的多模态处理能力。

## 1. 战略核心：从“设计”到“分类”

我们以一个关键的战略洞察开始了今天的工作：**将文档结构化（分割）与领域知识提取（打标）这两个不同性质的任务解耦。**

### 1.1 问题诊断

昨天的测试暴露了一个根本性问题：即使是强大的LLM，在面对一个要求它同时进行**语义分割**和**开放式知识提取/标签设计**的、高度复杂的单一任务时，也表现出不稳定性（“指令遗忘”）。

### 1.2 解决方案：聚焦与简化

我们决定进行一次战略性重构，将产品的核心使命重新聚焦于**文档结构化**。

-   **放弃开放式标签设计**: 我们不再要求LLM动态地设计或扩展标签字典。这个高认知负荷的任务被确认为不稳定的根源。
-   **拥抱受控分类**: 我们保留了用户自定义字典的功能，但将其重新定位为一个**封闭集的分类任务**。LLM的任务不再是“设计”，而是根据用户提供的、静态的schema进行“分类”。
-   **引入更精确的命名法**: 为了反映这个战略转变，我们将整个系统的命名体系进行了升级：
    -   `tags` -> `metadata`
    -   `tag_dictionary` -> `metadata_schema`

这次重构涉及了几乎所有的核心模块 (`data_models`, `config`, `llm_processor`, `postprocessor`, `main`)，最终使系统变得更加专注、可靠和可预测。

## 2. VLM整合：迈向多模态

在稳定了核心的文本处理流程后，我们开始集成VLM，以实现对文档中内嵌图片的高质量解析。

### 2.1 核心概念框架

我们建立了一套清晰的术语来指导我们的设计：

-   **Gross Split vs Fine Split**: 预分割（大块）与LLM的精细分割。
-   **Mega Chunk vs Atom Chunk**: 预分割的块与LLM生成的、语义独立的块。
-   **Pre-Enrichment vs Post-Enrichment**: 在`Fine Split`之前（如添加行号）和之后（如VLM处理）的富化操作。

### 2.2 架构演进：从“嵌入”到“解构与重构”

我们对VLM的集成经历了一次关键的架构迭代。

1.  **初步设计 (嵌入模式)**: 最初，我们计划将VLM生成的图片描述直接“嵌入”到包含该图片的`Atom Chunk`中。
2.  **发现致命缺陷**: 我们迅速意识到，这种方法会产生**“巨型块”**，严重污染`Atom Chunk`的语义纯粹性和尺寸合理性，对下游系统（如向量数据库）极其不友好。
3.  **最终架构 (解构与重构)**: 我们设计并实现了一个更先进的模式。`Post-Enrichment`流程现在会：
    a.  **解构**: 找到一个包含图片的`Atom Chunk`，并将其根据图片位置拆分为`text_before`, `image_tag`, `text_after`。
    b.  **调用VLM**: 获取图片描述。
    c.  **重构**: 将原始的一个块，重构为**多个新的、语义更纯粹的块**（文本块、图片块、文本块），并使用智能合并策略处理过小的文本碎片。

这个最终架构确保了每个输出的`Atom Chunk`都保持其语义独立和尺寸合理性，是整个项目中最精妙的设计之一。

## 3. 真实世界的工程挑战

在将新功能与真实数据（`minerU`处理的PDF输出）结合的测试中，我们遇到并解决了一系列典型的工程问题，极大地提升了系统的健壮性：

-   **文件编码**: 通过实现`UTF-8` -> `GBK`的回退逻辑，解决了`UnicodeDecodeError`。
-   **二进制文件污染**: 通过在预处理器中添加`.md`文件白名单过滤，优雅地跳过了无法处理的原始PDF文件。
-   **API上下文窗口限制**: 通过减小`long_doc_chunk_size`，成功避免了因提示词过长导致的API错误。
-   **路径解析**: 修正了在处理目录输入时，对图片相对路径解析不正确的问题。
-   **细微的逻辑Bug**: 修复了多个因大规模重构引入的、细微但致命的命名不一致和正则表达式错误。

## 4. 最终成果

经过今天的艰苦工作，`AgenticTextSplitter` 已经从一个强大的纯文本处理工具，演进为了一个**架构清晰、逻辑健壮、支持流式处理的、可配置的多模态文档结构化与富化引擎**。这是我们共同努力的卓越成果。
