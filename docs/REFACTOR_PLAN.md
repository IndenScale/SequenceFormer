# 战略性重构计划 V2：聚焦于受控的结构化分类

## 1. 目标

根据最新的战略澄清，本次重构的目标是**将标签系统从一个开放的、不稳定的“标签设计”模式，简化为一个封闭的、可靠的“分类”模式**。

我们将保留用户自定义标签字典的灵活性，但会移除要求LLM动态扩展或设计标签字典的高认知负荷任务。这将使我们的工具在核心的**文档结构化**任务上表现得更可靠，同时为用户提供一个强大的、可预测的**文档分类**功能。

## 2. 核心变更：简化的分类式标签字典

我们将保留用户提供标签字典的功能，但对其**结构和解释**进行战略性简化。

-   **新字典结构**: 用户提供的JSON字典将被解释为一个简单的、**“类别 -> 可选项”**的映射。它不再包含复杂的规则（如正则表达式或"..."）。
    *   **示例 `tag_dictionary.json`**:
        ```json
        {
          "Department": ["HR", "Engineering", "Sales", "Legal"],
          "Document Type": ["Memo", "Report", "Presentation", "Specification"],
          "Project Phase": ["Planning", "Execution", "Review"]
        }
        ```

-   **LLM的新任务**: LLM的任务不再是“填充模板”或“设计标签”，而是**“进行分类”**。对于每个文本块，它需要：
    1.  通读文本块。
    2.  对于字典中定义的每一个“类别”（如 "Department"），从其对应的列表中选择最合适的一个或多个标签。
    3.  如果某个类别完全不适用，则在输出中忽略该类别。

-   **状态简化**: LLM**不再需要返回更新后的标签字典**。标签字典在一次运行中是静态的、只读的。这极大地降低了对模型的指令遵循要求。

## 3. 重构步骤

### 步骤 1: 数据模型 (`src/data_models.py`)

1.  **修改 `LLMOutput`**:
    -   **移除** `tag_dictionary: Dict[str, Any]` 字段。这是本次重构最关键的简化。
2.  **修改 `ProcessingState`**:
    -   `tag_dictionary` 字段保持不变，它将在整个流程中作为只读的上下文被传递。
3.  **修改 `Chunk`**:
    -   `tags` 字段保持 `Dict[str, Any]`，用于存储分类结果，例如：`{"Department": "Engineering", "Document Type": "Specification"}`。

### 步骤 2: LLM处理器 (`src/llm_processor.py`)

1.  **修改 `build_prompt`**:
    -   **大幅简化**关于标签的指令。
    -   新的指令将非常清晰和直接：“对于每个块，请根据以下分类字典为其打上标签。对于每个类别，请从提供的列表中选择最合适的选项。如果某个类别不适用，请忽略它。”
    -   移除所有关于 `...`、正则表达式、以及要求LLM返回更新后字典的复杂指令。
    -   相应地简化输出格式的示例。

### 步骤 3: 后处理器 (`src/postprocessor.py`)

1.  **修改 `finalize_chunks_and_update_state`**:
    -   移除所有与接收和更新 `tag_dictionary` 状态相关的逻辑。
2.  **实现 `_validate_tags` (可选但推荐)**:
    -   可以实现一个简单的验证逻辑，检查LLM为每个类别返回的值，是否真的存在于原始标签字典的列表中。

### 步骤 4: 主流程 (`src/main.py`)

1.  **保持不变**: `main.py` 中加载标签字典并将其注入初始状态的逻辑是**完全正确**的，将予以保留。
2.  **修改 `argparse`**: 命令行参数 `--tag-dictionary` 的名称和功能保持不变，因为它准确地描述了其作用。

## 4. 预期收益

-   **可靠性大幅提升**: 通过将任务简化为“分割+分类”，而不是“分割+设计”，LLM（包括中小型模型）的指令遵循能力将得到质的提升，从而能稳定地返回所有必需的字段（如 `start_page`, `summary`）。
-   **保留用户价值**: 用户仍然可以通过提供自定义的JSON文件，来利用该工具完成针对其业务领域的、高度可控的文档分类任务。
-   **代码逻辑更清晰**: 移除了复杂的状态更新和规则解释逻辑，使代码更易于理解和维护。
-   **为未来铺路**: 这个高度可靠的“结构化+分类器”的输出，是未来独立的“知识抽取器”进行深度分析的完美输入。